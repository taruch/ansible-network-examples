---
- name: Generate a client certificate using Demo CA
  hosts: ansible-1
  become: true
  gather_facts: false

  vars:
    client: "{{ data.client | default('rtr1')}}"
    ca_passphrase: 'PASSW0RD'
    renewal_days: '21'

  tasks:
    - name: Delete files
      ansible.builtin.file:
        path: "/tmp/{{ client }}_{{ trustpoint }}.cer"
        state: absent

    - name: Generate Demo Certificate with OpenSSL from CSR
      ansible.builtin.expect:
        command: "openssl ca -config /opt/X509CA/openssl.cfg -in /tmp/{{ client }}_{{ trustpoint }}.csr -days {{ renewal_days }} -out /tmp/{{ client }}_{{ trustpoint }}.cer -notext"
        responses:
          'Enter pass phrase': "{{ ca_passphrase }}"
          'certificate?': 'y'
          'commit?': 'y'

    - name: Fix file permissions
      ansible.builtin.file:
        path: /tmp/{{ client }}_{{ trustpoint }}.cer
        owner: student
        group: student
        mode: '0644'

...
